@model Tipoul.AdminPanel.WebUI.Infrastructure.Builder.ListViewModel

@{
	var title = Model.GetTitle();
	var description = Model.GetDescription();

	var idPropertyInfo = Model.GetProperties().Where(f => f.Name == "Id").FirstOrDefault();

	var controller = Context.GetRouteValue("controller");
	var queryString = string.Join("&", Context.Request.Query.Where(f => f.Key != "pageNumber").Select(f => $"{f.Key}={f.Value}"));
}

<div class="card card-custom gutter-b">
	<div class="card-header flex-wrap py-3">
		<div class="card-title w-100">
			<h3 class="card-label">
				<span>@title</span>
				@if (!string.IsNullOrWhiteSpace(description))
				{
					<span class="d-block text-muted pt-2 font-size-sm">@description</span>
				}
			</h3>
			<div class="m-auto">
				@if (Context.Session.Keys.Contains("message") || true)
				{
					<div class="alert @Context.Session.GetString("message-class")px-5">@Context.Session.GetString("message")</div>
					Context.Session.Remove("message");
				}
			</div>
			<a class="btn btn-info btn-sm" href="/@controller/form" title="افزودن"><i class="fas fa-plus-circle"></i> افزودن</a>
		</div>
	</div>
	<div class="card-body">
		<div id="kt_datatable_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
			<div class="row">
				<div class="col-sm-12">
					@if (Model.Items.Count == 0)
					{
						<div class="alert alert-secondary text-center py-5">هیچ آیتمی برای نمایش وجود ندارد. <a class="btn btn-link btn-sm text-secondary" href="/@controller/form" title="افزودن"><u>برای افزودن کلیک کنید.</u></a></div>
					}
					else
					{
						<table class="table table-bordered table-checkable dataTable no-footer dtr-inline" id="kt_datatable" role="grid" aria-describedby="kt_datatable_info" style="width: 1245px;">
							<thead>
								<tr role="row">
									@foreach (var propertyInfo in Model.GetProperties().Where(propertyInfo => propertyInfo != idPropertyInfo))
									{
										<th>@Model.GetHeaderTitle(propertyInfo)</th>
									}
									<th>عملیات</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var item in Model.Items)
								{
									var id =0;// idPropertyInfo.GetValue(item);
									<tr role="row" class="odd">
										@foreach (var propertyInfo in Model.GetProperties().Where(propertyInfo => propertyInfo != idPropertyInfo))
										{
											var value = GetValue(propertyInfo, item);

											<td>@Html.Raw(value)</td>
										}
										<td nowrap="">
											<a href="/@controller/form/@id" class="btn btn-sm btn-clean btn-icon mr-2" title="ویرایش">
												<span class="svg-icon svg-icon-md">
													<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
														<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
															<rect x="0" y="0" width="24" height="24"></rect>
															<path d="M8,17.9148182 L8,5.96685884 C8,5.56391781 8.16211443,5.17792052 8.44982609,4.89581508 L10.965708,2.42895648 C11.5426798,1.86322723 12.4640974,1.85620921 13.0496196,2.41308426 L15.5337377,4.77566479 C15.8314604,5.0588212 16,5.45170806 16,5.86258077 L16,17.9148182 C16,18.7432453 15.3284271,19.4148182 14.5,19.4148182 L9.5,19.4148182 C8.67157288,19.4148182 8,18.7432453 8,17.9148182 Z" fill="#000000" fill-rule="nonzero" transform="translate(12.000000, 10.707409) rotate(-135.000000) translate(-12.000000, -10.707409) "></path>	                                        <rect fill="#000000" opacity="0.3" x="5" y="20" width="15" height="2" rx="1"></rect>
														</g>
													</svg>
												</span>
											</a>
											<a href="javascript:;" class="btn btn-sm btn-clean btn-icon" title="حذف" onclick="ShowDeleteModal(@id)">
												<span class="svg-icon svg-icon-md">
													<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
														<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
															<rect x="0" y="0" width="24" height="24"></rect>
															<path d="M6,8 L6,20.5 C6,21.3284271 6.67157288,22 7.5,22 L16.5,22 C17.3284271,22 18,21.3284271 18,20.5 L18,8 L6,8 Z" fill="#000000" fill-rule="nonzero"></path>
															<path d="M14,4.5 L14,4 C14,3.44771525 13.5522847,3 13,3 L11,3 C10.4477153,3 10,3.44771525 10,4 L10,4.5 L5.5,4.5 C5.22385763,4.5 5,4.72385763 5,5 L5,5.5 C5,5.77614237 5.22385763,6 5.5,6 L18.5,6 C18.7761424,6 19,5.77614237 19,5.5 L19,5 C19,4.72385763 18.7761424,4.5 18.5,4.5 L14,4.5 Z" fill="#000000" opacity="0.3"></path>
														</g>
													</svg>
												</span>
											</a>
										</td>
									</tr>
								}
							</tbody>
						</table>
					}
				</div>
			</div>
			@if (Model.PagesCount > 1)
			{
				<div class="row">
					<div class="col-sm-12 col-md-7 dataTables_pager">
						<div class="dataTables_paginate paging_simple_numbers" id="kt_datatable_paginate">
							<ul class="pagination">
								@for (int i = 0; i < Model.PagesCount; i++)
								{
									if (i < Pages || Model.PagesCount - i <= Pages || Math.Abs(Model.PageIndex - i) <= Pages)
									{
										<li class="paginate_button page-item @(Model.PageIndex == i ? "active" : string.Empty)"><a href="@(controller)?pageNumber=@(i + 1)@(string.IsNullOrWhiteSpace(queryString) ? string.Empty : "&" + queryString)" class="page-link">@(i + 1)</a></li>
									}
									else if ((i == Pages && i + 2 != Model.PagesCount - Pages) || i + 1 == Model.PagesCount - Pages)
									{
										<li class="paginate_button page-item"><a href="#" onclick="event.preventDefault()" class="page-link">...</a></li>
									}
								}
							</ul>
						</div>
					</div>
				</div>
			}
		</div>
	</div>
</div>

<form class="modal" id="delete-modal" tabindex="-1" role="dialog" method="post" action="/@controller/delete">
	<input type="hidden" name="id" />
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header bg-danger">
				<h5 class="modal-title">تأیید حذف @title</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p><span class="text-danger">این عملیات قابل بازگشت نیست.</span><span>آیا مایل به حذف هستید؟</span></p>
			</div>
			<div class="modal-footer text-center">
				<button type="submit" class="btn btn-warning">تأیید و حذف</button>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">انصراف</button>
			</div>
		</div>
	</div>
</form>

<script>
	function ShowDeleteModal (id) {
		$("#delete-modal").modal("show").find("input").val(id);
	}
</script>

@functions {

	private const int Pages = 2;

	private string GetValue(System.Reflection.PropertyInfo propertyInfo, object item)
	{
		var value = propertyInfo.GetValue(item);

		if (propertyInfo.PropertyType == typeof(int))
			value = ((int)value).ToString("n0");

		if (propertyInfo.PropertyType == typeof(bool))
			value = "<i class='fa " + (((bool)value == true ? "fa-check-circle text-success" : "fa-times-circle text-danger")) + " icon-lg'></i>";

		if (propertyInfo.PropertyType == typeof(TimeSpan))
			value = ((TimeSpan)value).ToString("hh\\:mm");

		if (propertyInfo.PropertyType == typeof(DateTime))
			value = DateConverter.ToShamsy((DateTime)value);

		return value?.ToString();
	}
}